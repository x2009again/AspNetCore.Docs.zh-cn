<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>&#24102;&#26377; ASP.NET Core &#30340; Visual Studio &#23481;&#22120;&#24037;&#20855; </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="&#24102;&#26377; ASP.NET Core &#30340; Visual Studio &#23481;&#22120;&#24037;&#20855; ">
    <meta name="generator" content="docfx 2.56.4.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="host-and-deploy/docker/visual-studio-tools-for-docker">
<h1 id="visual-studio-container-tools-with-aspnet-core">带有 ASP.NET Core 的 Visual Studio 容器工具</h1>

<p>Visual Studio 2017 及更高版本支持构建、调试和运行面向 .NET Core 且已容器化的 ASP.NET Core 应用。 Windows 和 Linux 容器均受支持。</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/host-and-deploy/docker/visual-studio-tools-for-docker/samples">查看或下载示例代码</a>（<a class="xref" href="../../introduction-to-aspnet-core.html#how-to-download-a-sample">如何下载</a>）</p>
<h2 id="prerequisites">先决条件</h2>
<ul>
<li><a href="https://docs.docker.com/docker-for-windows/install/">Docker for Windows</a></li>
<li>带有 .NET Core 跨平台开发工作负载的 <a href="https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&amp;utm_source=docs.microsoft.com&amp;utm_campaign=inline+link&amp;utm_content=download+vs2019">Visual Studio 2019</a></li>
</ul>
<h2 id="installation-and-setup">安装和设置</h2>
<p>如需安装 Docker，请先通过<a href="https://docs.docker.com/docker-for-windows/install/#what-to-know-before-you-install">用于 Windows 的 Docker：安装须知</a>了解相关信息。 然后安装<a href="https://docs.docker.com/docker-for-windows/install/">用于 Windows 的 Docker</a>。</p>
<p>Docker for Windows 中的<a href="https://docs.docker.com/docker-for-windows/#shared-drives">共享驱动器</a>必须配置为支持卷映射和调试。 右键单击系统托盘中的 Docker 图标，单击“设置”，然后选择“共享驱动器”。 选择 Docker 存储文件的驱动器。 单击“应用”。</p>
<p><img src="visual-studio-tools-for-docker/_static/settings-shared-drives-win.png" alt="为容器选择本地驱动器 C 作为共享驱动器的对话框"></p>
<div class="TIP">
<h5>Tip</h5>
<p>未配置共享驱动器时，Visual Studio 2017 15.6 及更高版本会发出提示。</p>
</div>
<h2 id="add-a-project-to-a-docker-container">向 Docker 容器添加项目</h2>
<p>若要容器化 ASP.NET Core 项目，项目必须面向 .NET Core。 同时支持 Linux 和 Windows 容器。</p>
<p>向项目添加 Docker 支持后，可选择 Windows 或 Linux 容器。 Docker 主机必须运行类型相同的容器。 要更改正在运行的 Docker 实例中的容器类型，请右键单击系统托盘中的 Docker 图标，再选择“切换到 Windows 容器...”或“切换到 Linux 容器...”   。</p>
<h3 id="new-app">新应用</h3>
<p>使用“ASP.NET Core Web 应用”项目模板新建应用时，请选中“启用 Docker 支持”复选框：</p>
<p><img src="visual-studio-tools-for-docker/_static/enable-docker-support-check-box.png" alt="“启用 Docker 支持”复选框"></p>
<p>如果目标框架是 .NET Core，可通过 OS 下拉列表选择容器类型。</p>
<h3 id="existing-app">现有应用</h3>
<p>对于面向 .NET Core 的 ASP.NET Core 项目，可通过两个选项使用工具添加 Docker 支持。 在 Visual Studio 中打开项目，然后选择以下选项之一：</p>
<ul>
<li>从“项目”菜单中选择“Docker 支持” 。</li>
<li>右键单击“解决方案资源管理器”中的项目，然后选择“添加” &gt; “Docker 支持”  。</li>
</ul>
<p>Visual Studio 容器工具不支持向面向 .NET Framework 的现有 ASP.NET Core 项目添加 Docker。</p>
<h2 id="dockerfile-overview">Dockerfile 概述</h2>
<p>Dockerfile，用作创建最终 Docker 映像的方案，添加到项目根目录。 请参阅 <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile 引用</a>，了解其中的命令。 此特定 Dockerfile 使用<a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/">多阶段生成</a>，该生成包含四个不同的命名生成阶段：</p>
<div range="&gt;= aspnetcore-2.1">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>前面的 Dockerfile 基于 <a href="https://hub.docker.com/r/microsoft/dotnet/">microsoft/dotnet</a> 映像。 此基础映像包括 ASP.NET Core 运行时和 NuGet 包。 对该包进行了实时 (JIT) 编译，以提高启动性能。</p>
<p>如果选中了新建项目对话框的“为 HTTPS 配置”复选框，则 Dockerfile 公开两个端口。 一个端口用于 HTTP 流量；另一个端口用于 HTTPS。 如果未选中该复选框，则为 HTTP 流量公开单个端口 (80)。</p>
</div>
<div range="&lt;= aspnetcore-2.0">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>前面的 Dockerfile 基于 <a href="https://hub.docker.com/r/microsoft/aspnetcore/">microsoft/aspnetcore</a> 映像。 此基础映像包括 ASP.NET Core NuGet 包，对该包进行了实时编译 (JIT)，以提高启动性能。</p>
</div>
<h2 id="add-container-orchestrator-support-to-an-app">向应用添加容器业务流程协调程序支持</h2>
<p>Visual Studio 2017 版本 15.7 或更早版本支持 <a href="https://docs.docker.com/compose/overview/">Docker Compose</a> 作为唯一的容器业务流程解决方案。 可通过“添加” &gt; “Docker 支持”添加 Docker Compose 。</p>
<p>Visual Studio 2017 版本 15.8 或更高版本仅在获得指示时添加业务流程解决方案。 右键单击“解决方案资源管理器”中的项目，然后选择“添加” &gt; “容器业务流程协调程序支持”  。 可用选项如下：</p>
<ul>
<li><a href="#docker-compose">Docker Compose</a></li>
<li><a href="#service-fabric">Service Fabric</a></li>
<li><a href="https://helm.sh/">Kubernetes/Helm </a></li>
</ul>
<h3 id="docker-compose">Docker Compose</h3>
<p>Visual Studio 容器工具通过以下文件向解决方案添加 docker-compose 项目：</p>
<ul>
<li>docker-compose.dcproj：表示项目的文件。 包括 <code>&lt;DockerTargetOS&gt;</code> 元素，用于指定要使用的操作系统。</li>
<li>.dockerignore：列出在生成生成上下文时要排除的文件和目录模式。</li>
<li>docker-compose.yml：基本 <a href="https://docs.docker.com/compose/overview/">Docker Compose</a> 文件，用于定义要分别通过 <code>docker-compose build</code> 和 <code>docker-compose run</code> 生成和运行的映像集合。</li>
<li>docker-compose.override.yml：一个可选文件，通过 Docker Compose 读取，包含服务的配置替代。 Visual Studio 执行 <code>docker-compose -f &quot;docker-compose.yml&quot; -f &quot;docker-compose.override.yml&quot;</code> 以合并这些文件。</li>
</ul>
<p>docker-compose.yml 文件引用在项目运行时创建的映像的名称：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>在前面的示例中，应用在“调试”模式下运行时，<code>image: hellodockertools</code> 生成映像 <code>hellodockertools:dev</code>。 应用在“发布”模式下运行时，生成 <code>hellodockertools:latest</code> 映像。</p>
<p>如果将映像推送到注册表，则需要添加 <a href="https://hub.docker.com/">Docker Hub</a> 用户名（如 <code>dockerhubusername/hellodockertools</code>）作为映像名称的前缀名。 或者，更改映像名称，使其包含专用注册表 URL（如 <code>privateregistry.domain.com/hellodockertools</code>），具体取决于所用配置。</p>
<p>如果根据生成配置需要不同行为（例如，调试或发布），请添加特定于配置的 docker-compose 文件。 这些文件应根据生成配置进行命名（例如，docker-compose.vs.debug.yml 和 docker compose.vs.release.yml）并放置在与 docker-compose-override.yml 文件相同的位置。</p>
<p>使用特定于配置的替代文件，可以为调试和发布生成配置指定不同的配置设置（如环境变量或入口点）。</p>
<p>docker 项目必须是启动项目，Docker Compose 才会显示要在 Visual Studio 中显示的选项。</p>
<h3 id="service-fabric">Service Fabric</h3>
<p>除了基础<a href="#prerequisites">必备组件</a>外，<a href="/azure/service-fabric/">Service Fabric</a> 业务流程解决方案还需要以下必备组件：</p>
<ul>
<li><a href="https://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&amp;appid=MicrosoftAzure-ServiceFabric-CoreSDK">Microsoft Azure Service Fabric SDK</a> 版本 2.6 或更高版本</li>
<li>Visual Studio 的 Azure 开发工作负载</li>
</ul>
<p>Service Fabric 不支持在 Windows 上的本地开发群集中运行 Linux 容器。 如果项目已在使用 Linux 容器，Visual Studio 会提示切换到 Windows 容器。</p>
<p>Visual Studio 容器工具执行以下任务：</p>
<ul>
<li><p>向解决方案添加 &lt;project_name&gt;Application Service Fabric 应用程序项目。</p>
</li>
<li><p>向 ASP.NET Core 项目添加 Dockerfile 和 .dockerignore 文件 。 如果 ASP.NET Core 项目中已存在 Dockerfile，则其重命名为 Dockerfile.original 。 创建类似于以下形式的新 Dockerfile：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></li>
<li><p>将 <code>&lt;IsServiceFabricServiceProject&gt;</code> 元素添加到 ASP.NET Core 项目的 .csproj 文件：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></li>
<li><p>向 ASP.NET Core 项目添加 PackageRoot 文件夹。 该文件夹包含服务清单和新服务的设置。</p>
</li>
</ul>
<p>有关详细信息，请参阅<a href="/azure/service-fabric/service-fabric-host-app-in-a-container">将 Windows 容器中的 .NET 应用部署到 Azure Service Fabric</a>。</p>
<h2 id="debug">调试</h2>
<p>在工具栏的调试下拉列表中选择“Docker”，然后开始调试应用。 “输出”窗口的“Docker”视图显示发生的以下操作 ：</p>
<div range="&gt;= aspnetcore-2.1">
<ul>
<li>已获取 microsoft/dotnet 运行时映像的 2.1-aspnetcore-runtime 标记（如果缓存中尚不存在） 。 该映像可安装 ASP.NET Core 和.NET Core 运行时及其关联的库。 在生产环境中针对运行 ASP.NET Core 应用对其进行了优化。</li>
<li><code>ASPNETCORE_ENVIRONMENT</code> 环境变量设置为容器内的 <code>Development</code>。</li>
<li>公开了两个动态分配的端口：分别用于 HTTP 和 HTTPS。 可以使用 <code>docker ps</code> 命令查询分配给本地主机的端口。</li>
<li>应用已复制到容器。</li>
<li>默认浏览器使用动态分配端口启动，带有附加到容器的调试程序。</li>
</ul>
<p>最终得到的应用的 Docker 映像标记为“开发”。 该映像基于 microsoft/dotnet 基础映像的 2.1-aspnetcore-runtime 标记 。 在“包管理器控制台”(PMC) 窗口中运行 <code>docker images</code> 命令。 显示了计算机上的映像：</p>
<pre><code class="lang-console">REPOSITORY        TAG                     IMAGE ID      CREATED         SIZE
hellodockertools  dev                     d72ce0f1dfe7  30 seconds ago  255MB
microsoft/dotnet  2.1-aspnetcore-runtime  fcc3887985bb  6 days ago      255MB
</code></pre>
</div>
<div range="&lt;= aspnetcore-2.0">
<ul>
<li>已获取 microsoft/aspnetcore 运行时映像（如果缓存中尚不存在）。</li>
<li><code>ASPNETCORE_ENVIRONMENT</code> 环境变量设置为容器内的 <code>Development</code>。</li>
<li>端口 80 公开，并映射到 localhost 的动态分配端口。 该端口由 Docker 主机确定，并且可以使用 <code>docker ps</code> 进行查询。</li>
<li>应用已复制到容器。</li>
<li>默认浏览器使用动态分配端口启动，带有附加到容器的调试程序。</li>
</ul>
<p>最终得到的应用的 Docker 映像标记为“开发”。 该映像基于 microsoft/aspnetcore 基础映像。 在“包管理器控制台”(PMC) 窗口中运行 <code>docker images</code> 命令。 显示了计算机上的映像：</p>
<pre><code class="lang-console">REPOSITORY            TAG  IMAGE ID      CREATED        SIZE
hellodockertools      dev  5fafe5d1ad5b  4 minutes ago  347MB
microsoft/aspnetcore  2.0  c69d39472da9  13 days ago    347MB
</code></pre>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>因为“调试”配置使用卷装载提供迭代体验，因此，开发映像中缺少应用内容。 要推送映像，请使用“发布”配置。</p>
</div>
<p>在 PMC 中运行 <code>docker ps</code> 命令。 请注意，应用使用容器运行：</p>
<pre><code class="lang-console">CONTAINER ID        IMAGE                  COMMAND                   CREATED             STATUS              PORTS                   NAMES
baf9a678c88d        hellodockertools:dev   &quot;C:\\remote_debugge...&quot;   21 seconds ago      Up 19 seconds       0.0.0.0:37630-&gt;80/tcp   dockercompose4642749010770307127_hellodockertools_1
</code></pre>
<h2 id="edit-and-continue">编辑并继续</h2>
<p>对静态文件和 Razor 视图的更改会自动更新，无需执行编译步骤。 进行更改，保存并在浏览器中刷新，以查看更新。</p>
<p>必须在容器内编译和重启 Kestrel，才能修改代码文件。 更改后，按 <code>CTRL+F5</code> 执行过程，并在容器内启动应用。 未重新生成或停止 Docker 容器。 在 PMC 中运行 <code>docker ps</code> 命令。 请注意，截至 10 分钟前，原始容器仍在运行：</p>
<pre><code class="lang-console">CONTAINER ID        IMAGE                  COMMAND                   CREATED             STATUS              PORTS                   NAMES
baf9a678c88d        hellodockertools:dev   &quot;C:\\remote_debugge...&quot;   10 minutes ago      Up 10 minutes       0.0.0.0:37630-&gt;80/tcp   dockercompose4642749010770307127_hellodockertools_1
</code></pre>
<h2 id="publish-docker-images">发布 Docker 映像</h2>
<p>完成应用的开发和调试循环后，Visual Studio 容器工具可帮助创建应用的生产映像。 将配置下拉列表更改为“发布”，然后生成应用。 该工具从 Docker Hub 中获取 compile/publish 映像（如果缓存中尚不存在）。 生成了具有“latest”标签的映像，可以将其推送到专用注册表或 Docker Hub。</p>
<p>在 PMC 中运行 <code>docker images</code> 命令，查看映像列表。 显示了类似下面的输出：</p>
<div range="&gt;= aspnetcore-2.1">
<pre><code class="lang-console">REPOSITORY        TAG                     IMAGE ID      CREATED             SIZE
hellodockertools  latest                  e3984a64230c  About a minute ago  258MB
hellodockertools  dev                     d72ce0f1dfe7  4 minutes ago       255MB
microsoft/dotnet  2.1-sdk                 9e243db15f91  6 days ago          1.7GB
microsoft/dotnet  2.1-aspnetcore-runtime  fcc3887985bb  6 days ago          255MB
</code></pre>
</div>
<div range="&lt;= aspnetcore-2.0">
<pre><code class="lang-console">REPOSITORY                  TAG     IMAGE ID      CREATED         SIZE
hellodockertools            latest  cd28f0d4abbd  12 seconds ago  349MB
hellodockertools            dev     5fafe5d1ad5b  23 minutes ago  347MB
microsoft/aspnetcore-build  2.0     7fed40fbb647  13 days ago     2.02GB
microsoft/aspnetcore        2.0     c69d39472da9  13 days ago     347MB
</code></pre>
<p>自 .NET Core 2.1 起，前面的输出中列出的 <code>microsoft/aspnetcore-build</code> 和 <code>microsoft/aspnetcore</code> 映像替换为 <code>microsoft/dotnet</code> 映像。 有关详细信息，请参阅 <a href="https://github.com/aspnet/Announcements/issues/298">Docker 存储库迁移公告</a>。</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p><code>docker images</code> 命令返回存储库名称和标记标识为 <em>&lt;none&gt;</em> （上面未列出）的中间映像。 这些未命名映像由<a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/">多阶段生成</a> Dockerfile 生成。 它们可提高生成最终映像的效率 — 发生更改时，仅重新生成必要的层。 不再需要中间映像时，请使用 <a href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a> 命令将其删除。</p>
</div>
<p>可能希望生产或发布映像的大小比开发映像小。 由于卷映射，调试程序和应用从本地计算机运行，而不在容器内运行。 最新映像已打包必要的应用代码，以在主机上运行应用。 因此，增量是应用代码的大小。</p>
<h2 id="additional-resources">其他资源</h2>
<ul>
<li><a href="/visualstudio/containers">利用 Visual Studio 进行容器开发</a></li>
<li><a href="/azure/service-fabric/service-fabric-get-started">Azure Service Fabric：准备开发环境</a></li>
<li><a href="/azure/service-fabric/service-fabric-host-app-in-a-container">将 Windows 容器中的 .NET 应用部署到 Azure Service Fabric</a></li>
<li><a href="/azure/vs-azure-tools-docker-troubleshooting-docker-errors">使用 Docker 排查 Visual Studio 开发方面的问题</a></li>
<li><a href="https://github.com/Microsoft/DockerTools">Visual Studio 容器工具 GitHub 存储库</a></li>
<li><a class="xref" href="../../performance/memory.html#sc">使用 Docker 和小型容器的 GC</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
