<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>&#31532; 6 &#37096;&#20998;&#65292;ASP.NET Core &#20013;&#30340;&#25511;&#21046;&#22120;&#26041;&#27861;&#21644;&#35270;&#22270; </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="&#31532; 6 &#37096;&#20998;&#65292;ASP.NET Core &#20013;&#30340;&#25511;&#21046;&#22120;&#26041;&#27861;&#21644;&#35270;&#22270; ">
    <meta name="generator" content="docfx 2.56.4.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="tutorials/first-mvc-app/controller-methods-views">
<h1 id="part-6-controller-methods-and-views-in-aspnet-core">第 6 部分，ASP.NET Core 中的控制器方法和视图</h1>

<p>作者：<a href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<p>电影应用的开头不错，但展示效果不理想，例如，ReleaseDate 应为两个词。</p>
<p><img src="working-with-sql/_static/m55.png" alt="索引视图：Release Date 为一个词（没有空格），每个电影发行日期都显示时间中午 12 点"></p>
<p>打开 Models/Movie.cs 文件，并添加以下代码中突出显示的行：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>下一教程将介绍 <a href="/aspnet/mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-6">DataAnnotations</a>。 <a href="/dotnet/api/microsoft.aspnetcore.mvc.modelbinding.metadata.displaymetadata">Display</a> 特性指定要显示的字段名称的内容（本例中应为“Release Date”，而不是“ReleaseDate”）。 <a href="/dotnet/api/microsoft.aspnetcore.mvc.dataannotations.internal.datatypeattributeadapter">DataType</a> 属性指定数据的类型（日期），使字段中存储的时间信息不会显示。</p>
<p>要使 Entity Framework Core 能将 <code>Price</code> 正确地映射到数据库中的货币，则必须使用 <code>[Column(TypeName = &quot;decimal(18, 2)&quot;)]</code> 数据注释。 有关详细信息，请参阅<a href="/ef/core/modeling/relational/data-types">数据类型</a>。</p>
<p>浏览到 <code>Movies</code> 控制器，并将鼠标指针悬停在“编辑”链接上以查看目标 URL。</p>
<p><img src="controller-methods-views/_static/edit7.png" alt="鼠标悬停在“编辑”链接上的浏览器窗口，显示了 https://localhost:5001/Movies/Edit/5 的链接 URL"></p>
<p>“编辑”、“详细信息”和“删除”链接是在 Views/Movies/Index.cshtml 文件中由 Core MVC 定位标记帮助程序生成的  。</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p><a class="xref" href="../../mvc/views/tag-helpers/intro.html">标记帮助程序</a>使服务器端代码可以在 Razor 文件中参与创建和呈现 HTML 元素。 在上面的代码中，<code>AnchorTagHelper</code> 从控制器操作方法和路由 ID 动态生成 HTML <code>href</code> 特性值。在最喜欢的浏览器中使用“查看源”，或使用开发人员工具来检查生成的标记。 生成的 HTML 的一部分如下所示：</p>
<pre><code class="lang-html"> &lt;td&gt;
    &lt;a href=&quot;/Movies/Edit/4&quot;&gt; Edit &lt;/a&gt; |
    &lt;a href=&quot;/Movies/Details/4&quot;&gt; Details &lt;/a&gt; |
    &lt;a href=&quot;/Movies/Delete/4&quot;&gt; Delete &lt;/a&gt;
&lt;/td&gt;
</code></pre>
<p>重新调用在 Startup.cs 文件中设置的<a class="xref" href="../../mvc/controllers/routing.html">路由</a>的格式：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>ASP.NET Core 将 <code>https://localhost:5001/Movies/Edit/4</code> 转换为对 <code>Movies</code> 控制器的 <code>Edit</code> 操作方法的请求，参数 <code>Id</code> 为 4。 （控制器方法也称为操作方法。）</p>
<p><a class="xref" href="../../mvc/views/tag-helpers/intro.html">标记帮助程序</a>是 ASP.NET Core 中最受欢迎的新功能之一。 有关详细信息，请参阅<a href="#additional-resources">其他资源</a>。</p>
<p><a name="get-post"></a></p>
<p>打开 <code>Movies</code> 控制器并检查两个 <code>Edit</code> 操作方法。 以下代码显示了 <code>HTTP GET Edit</code> 方法，此方法将提取电影并填充由 Edit.cshtml Razor 文件生成的编辑表单。</p>
<div range="&gt;= aspnetcore-2.1">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>以下代码显示 <code>HTTP POST Edit</code> 方法，它会处理已发布的电影值：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<div range="&lt;= aspnetcore-2.0">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>以下代码显示 <code>HTTP POST Edit</code> 方法，它会处理已发布的电影值：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<p><code>[Bind]</code> 特性是防止<a href="/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application#overpost">过度发布</a>的一种方法。 只应在 <code>[Bind]</code> 特性中包含想要更改的属性。 有关详细信息，请参阅<a href="/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application">防止控制器过度发布</a>。 <a href="https://rachelappel.com/use-viewmodels-to-manage-data-amp-organize-code-in-asp-net-mvc-applications/">ViewModels</a> 提供了一种替代方法以防止过度发布。</p>
<p>请注意第二个 <code>Edit</code> 操作方法的前面是 <code>[HttpPost]</code> 特性。</p>
<div range="&gt;= aspnetcore-2.1">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<div range="&lt;= aspnetcore-2.0">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<p><code>HttpPost</code> 特性指定只能为 <code>POST</code> 请求调用此 <code>Edit</code> 方法。 可将 <code>[HttpGet]</code> 属性应用于第一个编辑方法，但不是必需，因为 <code>[HttpGet]</code> 是默认设置。</p>
<p><code>ValidateAntiForgeryToken</code> 特性用于<a class="xref" href="../../security/anti-request-forgery.html">防止请求伪造</a>，并与编辑视图文件 (Views/Movies/Edit.cshtml) 中生成的防伪标记相配对。 编辑视图文件使用<a class="xref" href="../../mvc/views/working-with-forms.html">表单标记帮助程序</a>生成防伪标记。</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p><a class="xref" href="../../mvc/views/working-with-forms.html">表单标记帮助程序</a>会生成隐藏的防伪标记，此标记必须与电影控制器的 <code>Edit</code> 方法中 <code>[ValidateAntiForgeryToken]</code> 生成的防伪标记相匹配。 有关详细信息，请参阅 <a class="xref" href="../../security/anti-request-forgery.html">阻止跨站点请求伪造 (XSRF/CSRF) 攻击 ASP.NET Core</a>。</p>
<p><code>HttpGet Edit</code> 方法采用电影 <code>ID</code> 参数，使用Entity Framework <code>FindAsync</code> 方法查找电影，并将所选电影返回到“编辑”视图。 如果无法找到电影，则返回 <code>NotFound</code> (HTTP 404)。</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>当基架系统创建“编辑”视图时，它会检查 <code>Movie</code> 类并创建代码为类的每个属性呈现 <code>&lt;label&gt;</code> 和 <code>&lt;input&gt;</code> 元素。 以下示例显示由 Visual Studio 基架系统生成的“编辑”视图：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>请注意视图模板在文件顶端有一个 <code>@model MvcMovie.Models.Movie</code> 语句。 <code>@model MvcMovie.Models.Movie</code> 指定视图期望的视图模板的模型为 <code>Movie</code> 类型。</p>
<p>基架的代码使用几个标记帮助程序方法来简化 HTML 标记。 <a class="xref" href="../../mvc/views/working-with-forms.html">标签标记帮助程序</a>显示字段的名称（“Title”、“ReleaseDate”、“Genre”或“Price”）。 <a class="xref" href="../../mvc/views/working-with-forms.html">输入标记帮助程序</a>呈现 HTML <code>&lt;input&gt;</code> 元素。 <a class="xref" href="../../mvc/views/working-with-forms.html">验证标记帮助程序</a>显示与该属性相关联的任何验证消息。</p>
<p>运行应用程序并导航到 <code>/Movies</code> URL。 点击“编辑”链接。 在浏览器中查看页面的源。 为 <code>&lt;form&gt;</code> 元素生成的 HTML 如下所示。</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p><code>&lt;input&gt;</code> 元素位于 <code>HTML &lt;form&gt;</code> 元素中，后者的 <code>action</code> 特性设置为发布到 <code>/Movies/Edit/id</code> URL。 当单击 <code>Save</code> 按钮时，表单数据将发布到服务器。 关闭 <code>&lt;/form&gt;</code> 元素之前的最后一行显示<a class="xref" href="../../mvc/views/working-with-forms.html">表单标记帮助程序</a>生成的隐藏的 <a class="xref" href="../../security/anti-request-forgery.html">XSRF</a> 标记。</p>
<h2 id="processing-the-post-request">处理 POST 请求</h2>
<p>以下列表显示了 <code>Edit</code> 操作方法的 <code>[HttpPost]</code> 版本。</p>
<div range="&gt;= aspnetcore-2.1">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<div range="&lt;= aspnetcore-2.0">
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div></div>
<p><code>[ValidateAntiForgeryToken]</code> 特性验证<a class="xref" href="../../mvc/views/working-with-forms.html">表单标记帮助程序</a>中的防伪标记生成器生成的隐藏的 <a class="xref" href="../../security/anti-request-forgery.html">XSRF</a> 标记</p>
<p><a class="xref" href="../../mvc/models/model-binding.html">模型绑定</a>系统采用发布的表单值，并创建一个作为 <code>movie</code> 参数传递的 <code>Movie</code> 对象。 <code>ModelState.IsValid</code> 方法验证表单中提交的数据是否可以用于修改（编辑或更新）<code>Movie</code> 对象。 如果数据有效，将保存此数据。 通过调用数据库上下文的 <code>SaveChangesAsync</code> 方法，将更新（编辑）的电影数据保存到数据库。 保存数据后，代码将用户重定向到 <code>MoviesController</code> 类的 <code>Index</code> 操作方法，此方法显示电影集合，包括刚才所做的更改。</p>
<p>在表单发布到服务器之前，客户端验证会检查字段上的任何验证规则。 如果有任何验证错误，则将显示错误消息，并且不会发布表单。 如果禁用 JavaScript，则不会进行客户端验证，但服务器将检测无效的发布值，并且表单值将与错误消息一起重新显示。 稍后在本教程中，我们将更详细地研究<a class="xref" href="../../mvc/models/validation.html">模型验证</a>。 Views/Movies/Edit.cshtml 视图模板中的<a class="xref" href="../../mvc/views/working-with-forms.html">验证标记帮助程序</a>负责显示相应的错误消息。</p>
<p><img src="controller-methods-views/_static/val.png" alt="“编辑”视图：不正确的“价格”值 abc 的异常，说明“价格”字段必须是一个数字。 不正确的“发布日期”值 xyz 的异常，请输入有效的日期。"></p>
<p>电影控制器中的所有 <code>HttpGet</code> 方法都遵循类似的模式。 它们获取电影对象（对于 <code>Index</code>获取的是对象列表）并将对象（模型）传递给视图。 <code>Create</code> 方法将空的电影对象传递给 <code>Create</code> 视图。 在方法的 <code>[HttpPost]</code> 重载中，创建、编辑、删除或以其他方式修改数据的所有方法都执行此操作。 以 <code>HTTP GET</code> 方式修改数据是一种安全隐患。 以 <code>HTTP GET</code> 方法修改数据也违反了 HTTP 最佳做法和架构 <a href="http://rest.elkstein.org/">REST</a> 模式，后者指定 GET 请求不应更改应用程序的状态。 换句话说，执行 GET 操作应是没有任何隐患的安全操作，也不会修改持久数据。</p>
<h2 id="additional-resources">其他资源</h2>
<ul>
<li><a class="xref" href="../../fundamentals/localization.html">全球化和本地化</a></li>
<li><a class="xref" href="../../mvc/views/tag-helpers/intro.html">标记帮助程序简介</a></li>
<li><a class="xref" href="../../mvc/views/tag-helpers/authoring.html">创作标记帮助程序</a></li>
<li><a class="xref" href="../../security/anti-request-forgery.html">阻止跨站点请求伪造 (XSRF/CSRF) 攻击 ASP.NET Core</a></li>
<li>防止控制器<a href="/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application">过度发布</a></li>
<li><a href="https://rachelappel.com/use-viewmodels-to-manage-data-amp-organize-code-in-asp-net-mvc-applications/">ViewModels</a></li>
<li><a class="xref" href="../../mvc/views/working-with-forms.html">表单标记帮助程序</a></li>
<li><a class="xref" href="../../mvc/views/working-with-forms.html">输入标记帮助程序</a></li>
<li><a class="xref" href="../../mvc/views/working-with-forms.html">标签标记帮助程序</a></li>
<li><a class="xref" href="../../mvc/views/working-with-forms.html">选择标记帮助程序</a></li>
<li><a class="xref" href="../../mvc/views/working-with-forms.html">验证标记帮助程序</a></li>
</ul>
<div class="step-by-step">
<p><a href="working-with-sql.html">上一页</a>
<a href="search.html">下一页</a></p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
