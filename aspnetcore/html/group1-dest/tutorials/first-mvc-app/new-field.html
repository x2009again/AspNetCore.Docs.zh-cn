<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>&#31532; 8 &#37096;&#20998;&#65292;&#23558;&#26032;&#23383;&#27573;&#28155;&#21152;&#21040; ASP.NET Core MVC &#24212;&#29992; </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="&#31532; 8 &#37096;&#20998;&#65292;&#23558;&#26032;&#23383;&#27573;&#28155;&#21152;&#21040; ASP.NET Core MVC &#24212;&#29992; ">
    <meta name="generator" content="docfx 2.56.4.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="tutorials/first-mvc-app/new-field">
<h1 id="part-8-add-a-new-field-to-an-aspnet-core-mvc-app">第 8 部分，将新字段添加到 ASP.NET Core MVC 应用</h1>

<p>作者：<a href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<p>在此部分中，<a href="/ef/core/get-started/aspnetcore/new-db">Entity Framework</a> Code First 迁移用于：</p>
<ul>
<li>将新字段添加到模型。</li>
<li>将新字段迁移到数据库。</li>
</ul>
<p>使用 EF Code First 自动创建数据库时，Code First 将：</p>
<ul>
<li>将表添加到数据库，以跟踪数据库的架构。</li>
<li>验证数据库与生成它的模型类是否同步。 如果它们不同步，EF 则会引发异常。 这使查找不一致的数据库/代码问题变得更加轻松。</li>
</ul>
<h2 id="add-a-rating-property-to-the-movie-model">向电影模型添加分级属性</h2>
<p>将 <code>Rating</code> 属性添加到 Models/Movie.cs：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>生成应用</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_visual-studio" role="tab" aria-controls="tabpanel_CeZOj-G++Q_visual-studio" data-tab="visual-studio" tabindex="0" aria-selected="true">Visual Studio</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_visual-studio-code" role="tab" aria-controls="tabpanel_CeZOj-G++Q_visual-studio-code" data-tab="visual-studio-code" tabindex="-1">Visual Studio Code</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_visual-studio-mac" role="tab" aria-controls="tabpanel_CeZOj-G++Q_visual-studio-mac" data-tab="visual-studio-mac" tabindex="-1">Visual Studio for Mac</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_visual-studio" role="tabpanel" data-tab="visual-studio">

<p>Ctrl+Shift+B</p>
</section>
<section id="tabpanel_CeZOj-G++Q_visual-studio-code" role="tabpanel" data-tab="visual-studio-code" aria-hidden="true" hidden="hidden">

<pre><code class="lang-dotnetcli">dotnet build
</code></pre>
</section>
<section id="tabpanel_CeZOj-G++Q_visual-studio-mac" role="tabpanel" data-tab="visual-studio-mac" aria-hidden="true" hidden="hidden">

<p>命令 ⌘ + B</p>
</section>
</div>

<p>因为已经添加新字段到 <code>Movie</code> 类，所以需要更新属性绑定列表，将此新属性纳入其中。 在 MoviesController.cs 中，更新 <code>Create</code> 和 <code>Edit</code> 操作方法的 <code>[Bind]</code> 属性，以包括 <code>Rating</code> 属性：</p>
<pre><code class="lang-csharp">[Bind(&quot;Id,Title,ReleaseDate,Genre,Price,Rating&quot;)]
</code></pre>
<p>更新视图模板以在浏览器视图中显示、创建和编辑新的 <code>Rating</code> 属性。</p>
<p>编辑 /Views/Movies/Index.cshtml 文件并添加 <code>Rating</code> 字段：</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>使用 <code>Rating</code> 字段更新 /Views/Movies/Create.cshtml。</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_visual-studio+visual-studio-mac" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_visual-studio+visual-studio-mac" data-tab="visual-studio+visual-studio-mac" tabindex="0" aria-selected="true">Visual Studio / Visual Studio for Mac</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_visual-studio-code" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_visual-studio-code" data-tab="visual-studio-code" tabindex="-1">Visual Studio Code</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_visual-studio+visual-studio-mac" role="tabpanel" data-tab="visual-studio+visual-studio-mac">

<p>可以复制/粘贴之前的“窗体组”，并让 intelliSense 帮助更新字段。 IntelliSense 适用于<a class="xref" href="../../mvc/views/tag-helpers/intro.html">标记帮助程序</a>。</p>
<p><img src="new-field/_static/cr.png" alt="开发人员已在视图的第二个标签元素中键入字母 R 用作 asp-for 的特性值。 出现了 Intellisense 上下文菜单，其中显示了可用字段，包括在列表中自动突出显示的“Rating”。 开发人员单击此字段或在键盘上按 Enter 键时，此值将设置为“Rating”。"></p>
</section>
<section id="tabpanel_CeZOj-G++Q-1_visual-studio-code" role="tabpanel" data-tab="visual-studio-code" aria-hidden="true" hidden="hidden">
<!-- This tab intentionally left blank. -->
</section>
</div>

<p>更新剩余模板。</p>
<p>更新 <code>SeedData</code> 类，使它提供新列的值。 示例更改如下所示，但可能需要对每个 <code>new Movie</code> 做出此更改。</p>
<div class="WARNING">
<h5>Warning</h5>
<p>It looks like the sample you are looking for does not exist.</p>
</div>
<p>在 DB 更新为包括新字段之前，应用将不会正常工作。 如果它现在运行，将引发以下 <code>SqlException</code>：</p>
<p><code>SqlException: Invalid column name 'Rating'.</code></p>
<p>发生此错误是因为更新的 Movie 模型类与现有数据库的 Movie 表架构不同。 （数据库表中没有 <code>Rating</code> 列。）</p>
<p>可通过几种方法解决此错误：</p>
<ol>
<li><p>让 Entity Framework 自动丢弃，并基于新的模型类架构重新创建数据库。 在测试数据库上进行开发时，此方法在开发周期早期很方便；通过它可以一起快速改进模型和数据库架构。 但其缺点是会丢失数据库中的现有数据 - 因此请勿对生产数据库使用此方法！ 使用初始值设定项，以使用测试数据自动设定数据库种子，这通常是开发应用程序的有效方式。 对于早期开发和使用 SQLite 的情况，这是一个不错的方法。</p>
</li>
<li><p>对现有数据库架构进行显式修改，使它与模型类相匹配。 此方法的优点是可以保留数据。 可以手动或通过创建数据库更改脚本进行此更改。</p>
</li>
<li><p>使用 Code First 迁移更新数据库架构。</p>
</li>
</ol>
<p>对于本教程，请使用 Code First 迁移。</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-2">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_visual-studio" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_visual-studio" data-tab="visual-studio" tabindex="0" aria-selected="true">Visual Studio</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-2_visual-studio-code+visual-studio-mac" role="tab" aria-controls="tabpanel_CeZOj-G++Q-2_visual-studio-code+visual-studio-mac" data-tab="visual-studio-code+visual-studio-mac" tabindex="-1">Visual Studio Code / Visual Studio for Mac</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-2_visual-studio" role="tabpanel" data-tab="visual-studio">

<p>从“工具”菜单中，选择“NuGet 包管理器”&gt;“包管理器控制台”。</p>
<p><img src="adding-model/_static/pmc.png" alt="PMC 菜单"></p>
<p>在 PMC 中，输入以下命令：</p>
<pre><code class="lang-powershell">Add-Migration Rating
Update-Database
</code></pre>
<p><code>Add-Migration</code> 命令会通知迁移框架使用当前 <code>Movie</code> DB 架构检查当前 <code>Movie</code> 模型，并创建必要的代码，将 DB 迁移到新模型。</p>
<p>名称“Rating”是任意的，用于对迁移文件进行命名。 为迁移文件使用有意义的名称是有帮助的。</p>
<p>如果删除 DB 中的所有记录，初始化方法会设定 DB 种子，并将包括 <code>Rating</code> 字段。</p>
</section>
<section id="tabpanel_CeZOj-G++Q-2_visual-studio-code+visual-studio-mac" role="tabpanel" data-tab="visual-studio-code+visual-studio-mac" aria-hidden="true" hidden="hidden">
<div class="NOTE">
<h5>Note</h5>
<p>在本教程中，使用 Entity Framework Core 迁移功能（若可行）。 迁移会更新数据库架构，使其与数据模型中的更改相匹配。 但是，迁移仅能执行 EF Core 提供程序所支持的更改类型，且 SQLite 提供程序的功能将受限。 例如，支持添加列，但不支持删除或更改列。 如果已创建迁移以删除或更改列，则 <code>ef migrations add</code> 命令将成功，但 <code>ef database update</code> 命令会失败。 由于上述限制，本教程不对 SQLite 架构更改使用迁移。 转而在架构更改时，放弃并重新创建数据库。</p>
<p>要绕开 SQLite 限制，可手动写入迁移代码，在表内容更改时重新生成表。 表重新生成涉及：</p>
<ul>
<li>创建新表。</li>
<li>将旧表中的数据复制到新表中。</li>
<li>放弃旧表。</li>
<li>为新表重命名。</li>
</ul>
<p>有关更多信息，请参见以下资源：</p>
<ul>
<li><a href="/ef/core/providers/sqlite/limitations">SQLite EF Core 数据库提供程序限制</a></li>
<li><a href="/ef/core/managing-schemas/migrations/#customize-migration-code">自定义迁移代码</a></li>
<li><a href="/ef/core/modeling/data-seeding">数据种子设定</a></li>
</ul>
</div>
<ul>
<li><a href="https://sqlite.org/lang_altertable.html">SQLite ALTER TABLE 语句</a></li>
</ul>

<p>删除数据库和上一次迁移，然后使用迁移重新创建数据库：</p>
<pre><code class="lang-dotnetcli">dotnet ef migrations remove
dotnet ef database drop
dotnet ef migrations add InitialCreate
dotnet ef database update
</code></pre>
<p><code>dotnet ef migrations remove</code> 删除上一次迁移。 如果有多个迁移，请删除“迁移”文件夹。</p>
</section>
</div>
<!-- End of VS tabs -->
<p>运行应用，并验证是否可以创建、编辑和显示具有 <code>Rating</code> 字段的电影。</p>
<div class="step-by-step">
<p><a href="search.html">上一页</a>
<a href="validation.html">下一页</a></p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
